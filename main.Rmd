```{r, warning=FALSE, echo=FALSE}
devtools::load_all(file.path('~/antigenic_space', 'libs', 'fasanalysis'))
pacman::p_load('data.table')
pacman::p_load('ggplot2')
pacman::p_load('rlm')
pacman::p_load('dplyr')
if (!require('DESeq2')) {
  source("https://bioconductor.org/biocLite.R")
  biocLite("DESeq2")
}
library('DESeq2')
theme_set(theme_bw())

inspect_mat <- function(mat) {
  print(class(mat)); print(dim(mat)); print(mat[1:5, 1:5])
}

# theme_set(theme_fas())
# qplot(1:3)
```


```{r, load_transcriptome, warning=FALSE, echo=FALSE}
dat_path <- file.path('~/Dropbox', 'PDX_CL_DP_TS_project', 
                      'RNAseq_data', 'DESeq2_normalized.RData')
if (!exists("Sample_annotation")) load(dat_path)
# ls()
# Gene_annotation
# tail(Sample_annotation)
# head(Sample_annotation)
# head(RC_data)
# str(RC_data)
# class(Sample_annotation)
# colnames(Sample_annotation)
# Sample_annotation$File_name

idx <- (is.na(Sample_annotation$Hours) | Sample_annotation$Hours == 24) & 
       Sample_annotation$Treatment %in% c('Untreated')
soi <- as.character(Sample_annotation$File_name[idx])
Sample_names <- paste(Sample_annotation$Cell_line[idx], 
                      Sample_annotation$Treatment[idx], sep = '_')
# Sample_annotation[Sample_annotation$File_name %in% soi, ]
RC_f <- RC_data[, c('external_gene_id', soi)]
colnames(RC_f) <- c('external_gene_id', Sample_names)
RC_f <- aggregate(. ~ external_gene_id, RC_f, sum)
RC_f$external_gene_id
col_facs <- 1e-6 * apply(RC_f[, Sample_names], 2, sum)
RC_f_n <- scale(RC_f[, Sample_names], center = F, scale = col_facs) 
inspect_mat(RC_f_n)
## TODO Check this statement for validity
rownames(RC_f_n) <- as.character(RC_f$external_gene_id)
# RC_f_n$sample <- Sample_names
# RC_f_n <- as.data.frame(RC_f_n)
# single_genes <- RC_f$external_gene_id[table(RC_f$external_gene_id) == 1]
stopifnot(all(dim(RC_f) < dim(RC_data)))
RC_f_n <- RC_f[, Sample_names] / apply(RC_f[, Sample_names], 2, sum)
inspect_mat(RC_f_n)
```

```{r, load_upreg, warning=FALSE, echo=FALSE}
dat_path <- file.path('~/Dropbox', 'PDX_CL_DP_TS_project', 'Response_data', 
                      'cell_surface_data.csv')
fh <- fread(dat_path)

setnames(fh, c('cell_line', 
               paste(rep(c('MHC', 'PDL1'), each = 4), 
                     c('US', '0', '1', '10'), sep = "_")))
fh <- fh[-1]
num_cols <- setdiff(colnames(fh), 'cell_line')
fh[, (num_cols) := lapply(.SD, function(x) as.numeric(gsub(',', '.', x))), 
   .SDcols = num_cols]

setkey(fh, cell_line)
fh <- fh[gsub('.CL_Untreated', '', rownames(RC_f_n))] 
fh[gsub('.CL_Untreated', '', rownames(RC_f_n))] 

ggplot(fh, aes(x = PDL1_US, y = PDL1_10 / PDL1_US, label = cell_line)) + 
  geom_point() +
  geom_text(hjust = -.2) +
  geom_smooth() +
  scale_x_continuous(expand = c(.2, 0))

ggplot(fh, aes(x = PDL1_US, y = PDL1_10, label = cell_line)) + 
  geom_point() +
  geom_text(hjust = -.2) +
  geom_smooth() +
  scale_x_continuous(expand = c(.2, 0))

fh[, PDL1_10 / PDL1_US]
```


