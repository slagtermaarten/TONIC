```{r, warning=FALSE, echo=FALSE, include=F}
source('R/load_data.R')
```

Investigate the effect of various induction treatments on tumor immune profiles.

```{r, warning=FALSE, echo=FALSE}
patient_labels.m <- melt(patient_labels,
                         id.vars = c('patient', 'response', 'tis_score',
                                     'clinical_response',
                                     'mean_log2_hk', 'qc_status', 'arm'))
dcast(patient_labels.m, . ~ patient)
```

```{r, warning=FALSE, echo=FALSE}
plot_single_gene_fc <- function(gene_symbol = 'CD274',
                                    timepoints = c(1,2)) {
  allowed_patients <- patient_labels[timepoint %in% timepoints,
                                     .N >= 2, by = patient][V1 == TRUE, patient]
  gene_idx <- exp_levels[, which(gene_symbol == parent.frame(3)$gene_symbol)]

  setkey(patient_labels, patient)
  res <- lapply(timepoints, function(tp) {
    exp_levels[gene_idx,
               patient_labels[allowed_patients][timepoint == tp, as.character(filename)],
               with = F] %>% unlist %>% setNames(., NULL)
  }) %>% { data.table('patient' = allowed_patients,
                      'tp_a' = .[[1]], 'tp_b' = .[[2]]) }
  res <- merge(res, patient_labels[, .(patient, response, arm)], by = 'patient')

  res[, 'fc' := log2(tp_b) - log2(tp_a)]
  x_var = 'tp_a'; y_var = 'fc'
  colour_var = 'arm'
  colour_var = 'response'

  p <- ggplot(res, aes_string(x = x_var, y = y_var, colour = colour_var)) +
    geom_vline(linetype = 'dashed', 
               xintercept = median(res[, get(x_var)], na.rm = T), alpha = .5) +
    geom_hline(linetype = 'dashed', 
               yintercept = median(res[, get(y_var)], na.rm = T), alpha = .5) +
    geom_point(alpha = .5) +
    theme_bw() +
    scale_x_continuous(name = sprintf('%s time point %d', gene_symbol,
                                      timepoints[1])) +
    scale_y_continuous(name = sprintf('log(fc) %s time points %d & %d', gene_symbol,
                                      timepoints[1], timepoints[2])) +
    scale_colour_discrete() +
    ggtitle(gene_symbol)

  ## Draw median cross hairs
  x_width <- diff(res[, range(get(x_var))]) / 20
  y_width <- diff(res[, range(get(y_var))]) / 20
  p <- p + geom_segment(aes(x = V1 - x_width, y = V2,
                            xend = V1 + x_width, yend = V2),
                        lineend = 'butt',
                        data = res[, .(median(get(x_var), na.rm = T),
                                       median(get(y_var), na.rm = T)), by = colour_var])
  p <- p + geom_segment(aes(x = V1, y = V2 + y_width,
                            xend = V1, yend = V2 - y_width),
                        lineend = 'butt',
                        data = res[, .(median(get(x_var), na.rm = T),
                                       median(get(y_var), na.rm = T)),
                        by = colour_var])
  return(p)

}

plot_single_gene_fc()
```


```{r, warning=FALSE, echo=FALSE}
plot_single_score_fc <- function(gene_symbol = 'CD274',
                                    timepoints = c(1,2)) {
  allowed_patients <- patient_labels[timepoint %in% timepoints,
                                     .N >= 2, by = patient][V1 == TRUE, patient]
  gene_idx <- exp_levels[, which(gene_symbol == parent.frame(3)$gene_symbol)]

  setkey(patient_labels, patient)
  res <- lapply(timepoints, function(tp) {
    exp_levels[gene_idx,
               patient_labels[allowed_patients][timepoint == tp, as.character(filename)],
               with = F] %>% unlist %>% setNames(., NULL)
  }) %>% { data.table('patient' = allowed_patients,
                      'tp_a' = .[[1]], 'tp_b' = .[[2]]) }
  res <- merge(res, patient_labels[, .(patient, response, arm)], by = 'patient')

  res[, 'fc' := log2(tp_b) - log2(tp_a)]
  x_var = 'tp_a'; y_var = 'fc'
  colour_var = 'arm'
  colour_var = 'response'

  p <- ggplot(res, aes_string(x = x_var, y = y_var, colour = colour_var)) +
    geom_vline(linetype = 'dashed', 
               xintercept = median(res[, get(x_var)], na.rm = T), alpha = .5) +
    geom_hline(linetype = 'dashed', 
               yintercept = median(res[, get(y_var)], na.rm = T), alpha = .5) +
    geom_point(alpha = .5) +
    theme_bw() +
    scale_x_continuous(name = sprintf('%s time point %d', gene_symbol,
                                      timepoints[1])) +
    scale_y_continuous(name = sprintf('log(fc) %s time points %d & %d', gene_symbol,
                                      timepoints[1], timepoints[2])) +
    scale_colour_discrete() +
    ggtitle(gene_symbol)

  ## Draw median cross hairs
  x_width <- diff(res[, range(get(x_var))]) / 20
  y_width <- diff(res[, range(get(y_var))]) / 20
  p <- p + geom_segment(aes(x = V1 - x_width, y = V2,
                            xend = V1 + x_width, yend = V2),
                        lineend = 'butt',
                        data = res[, .(median(get(x_var), na.rm = T),
                                       median(get(y_var), na.rm = T)), by = colour_var])
  p <- p + geom_segment(aes(x = V1, y = V2 + y_width,
                            xend = V1, yend = V2 - y_width),
                        lineend = 'butt',
                        data = res[, .(median(get(x_var), na.rm = T),
                                       median(get(y_var), na.rm = T)),
                        by = colour_var])
  return(p)

}

plot_single_gene_by_arm()
```
