```{r, warning=FALSE, echo=FALSE, include=F}
# source('~/antigenic_space/bin/install_packages.R')
library(maartenutils)
source('R/load_data.R')
source('R/ML.R')
source('R/plotting.R')
ggplot2::theme_set(theme_ms(base_size = 8))
```

Investigate the effect of various induction treatments on tumor immune profiles.

```{r, warning=FALSE, echo=FALSE}
plot_single_gene_fc()
```

```{r, warning=FALSE, echo=FALSE}
p_dat %>% .[variable == 'tis'] %>%
  plot_timepoint_comparison(x_var = x_var, y_var = y_var,
                            N_lines = 11,
                            colour_var = 'arm')
```

```{r, eval = F, warning=FALSE, echo=FALSE}
x <- seq(0, 10, by = .1)
plot(x, dgamma(x = x, shape = 5, rate = 4))
# plot(x, dbeta(x = x, shape1 = 2, shape2 = 2))
```

```{r, warning=FALSE, echo=FALSE}
plot_bivariates(x_var = 'baseline', y_var = 'post.induction',
                colour_var = 'arm')
```

```{r, warning=FALSE, echo=FALSE}
p_dat %>% .[variable == 'tis'] %>%
  plot_timepoint_comparison(x_var = x_var, y_var = y_var,
                            N_lines = 17,
                            colour_var = 'response')
```

```{r, eval = F, warning=FALSE, echo=FALSE}
## Does not work for some reason
p <- p_dat %>%
  plot_timepoint_comparison(x_var = x_var, y_var = y_var, colour_var = 'arm')
ggplot2::facet_grid(p, as.formula('. ~ variable'))
```

# Parallel coordinates plots

Geneset level

```{r, warning=FALSE, echo=FALSE}
colour_var = 'response'
plots <- lapply(danaher_scores.m[, unique(variable)],
                plot_parallel_coords_geneset,
                colour_var = colour_var)
filename <- file.path(img_dir, sprintf('parallel_%s.pdf', colour_var))

maartenutils::plot_panel_layout(plots, ncol = 5, filename = filename, 
                  labels = NULL,
                  w = 22, h = length(plots) / 5 * 9, 
                  label_size = 8)
sys_file_open(filename)
```

Gene level

```{r, warning=FALSE, echo=FALSE}
source('R/plotting.R')
colour_var = 'response'
genes = exp_levels[, sort(unique(gene_symbol))] %>% 
  # qs %>% 
  as.character

N_plots <- length(genes)
ppp <- 15
N_pages <- ceiling(N_plots / ppp) 
N_brackets <- (ceiling(N_plots / ppp) * ppp)
plot_idx <- suppressWarnings(base::split(1:N_plots, rep(1:N_pages, each = ppp)))

plyr::l_ply(seq_along(plot_idx), function(idx) {
  li <- plot_idx[[idx]]
  if (length(li) == 0 || all(is.na(li))) return(NULL)
  plots <- lapply(genes[li],
                  plot_parallel_coords_single_gene,
                  colour_var = colour_var)
  fn <- sprintf('plots/parallel_single_gene_idx-%s_%s.pdf', idx, colour_var)
  plot_panel_layout(plots, ncol = 4, nrow = 4,
                    filename = fn, 
                    w = 22, h = length(plots) / 5 * 9, 
                    label_size = 8)
})
```
